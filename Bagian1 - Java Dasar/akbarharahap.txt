--dblink report receiving
CREATE OR REPLACE FUNCTION public.get_report_receiving(kodeahass character varying, startdate character varying, enddate character varying, warehouse_code character varying, part_id character varying)
 RETURNS TABLE(NoReferensi character varying, partnumber character varying, qtyreceving int, TglReceipt timestamp, tglsj character varying, description character varying, hargasatuan double precision, WH character varying, Subinventory character varying, locator character varying, discountvalue double precision, total double precision)
 LANGUAGE plpgsql
AS $function$  
begin
  RETURN QUERY
select rcv.*
  from dblink('dbname=ddmsh3_trn_cbr host=localhost user=ddmsh3app password=h1h2h3bandung port=5432'::text, 
      format('SELECT * FROM public.report_receiving(%L, %L, %L, %L, %L)', kodeahass, startdate, enddate, warehouse_code, part_id)) rcv
      (NoReferensi character varying, partnumber character varying, qtyreceving int, TglReceipt timestamp, tglsj character varying, description character varying, hargasatuan double precision, WH character varying, Subinventory character varying, locator character varying, discountvalue double precision, total double precision);
end; 
$function$
;

select * from public.get_report_receiving('100002', '01-08-2023 00:00:00', '31-08-2023 23:59:59', null, null);
select * from public.get_report_receiving($P{ahassid}, $P{startdate}, $P{enddate}, $P{warehouse_code}, $P{part_id});
drop function public.get_report_receiving;

CREATE OR REPLACE FUNCTION public.get_report_stock_lengkap(warehouse_code character varying, subinventory_code character varying, kodeahass character varying, locator_code character varying, part_group character varying, part_id character varying)
 RETURNS TABLE(ahass_id character varying, description character varying, partgroup character varying, warehouse character varying, subinventory character varying, partid character varying, locatorid bigint, code character varying, quantity bigint, avb bigint)
 LANGUAGE plpgsql
AS $function$  
begin
  RETURN QUERY
select stk_lengkap.*
  from dblink('dbname=ddmsh3_trn_cbr host=localhost user=ddmsh3app password=h1h2h3bandung port=5432'::text, 
      format('SELECT * FROM public.report_stock_lengkap(%L, %L, %L, %L, %L, %L)', warehouse_code, subinventory_code, kodeahass, locator_code, part_group, part_id)) stk_lengkap
      (ahass_id character varying, description character varying, partgroup character varying, warehouse character varying, subinventory character varying, partid character varying, locatorid bigint, code character varying, quantity bigint, avb bigint);
end; 
$function$
;

select * from public.get_report_stock_lengkap('WH/00999/1', '00999.WHA.S1', '100002', 'A1.08.4.1', null, null);
select * from public.get_report_stock_lengkap($P{warehouse_code}, $P{subinventory_code}, $P{kodeahass}, $P{locator_code}, $P{part_group}, $P{part_id});
drop function public.get_report_stock_lengkap




CREATE OR REPLACE FUNCTION public.get_report_stock_sederhana(warehouse_code character varying, subinventory_code character varying, kodeahass character varying, part_group character varying, part_id character varying)
 RETURNS TABLE(partid character varying, description character varying, quantity bigint)
 LANGUAGE plpgsql
AS $function$  
begin
  RETURN QUERY
select stk_sederhana.*
  from dblink('dbname=ddmsh3_trn_cbr host=localhost user=ddmsh3app password=h1h2h3bandung port=5432'::text, 
      format('SELECT * FROM public.report_stock_sederhana(%L, %L, %L, %L, %L)', warehouse_code, subinventory_code, kodeahass, part_group, part_id)) stk_sederhana
      (partid character varying, description character varying, quantity bigint);
end; 
$function$
;

select * from public.get_report_stock_sederhana('WH/00999/1', '00999.WHA.S1', '100002', null, '08294M99Z8YZ1');
select * from public.get_report_stock_sederhana($P{warehouse_code}, $P{subinventory_code}, $P{kodeahass}, $P{part_group}, $P{part_id});


CREATE OR REPLACE FUNCTION public.get_open_po_report(ahass_code character varying)
 RETURNS TABLE(code character varying, description character varying, awaitingopenpo numeric, receivedopenpo numeric, jumlah numeric)
 LANGUAGE plpgsql
AS $function$  
begin
  RETURN QUERY
select open_po.*
  from dblink('dbname=ddmsh3_trn_cbr host=localhost user=ddmsh3app password=h1h2h3bandung port=5432'::text, 
      format('SELECT * FROM public.open_po_report(%L)', ahass_code)) open_po
      (code character varying, description character varying, awaitingopenpo numeric, receivedopenpo numeric, jumlah numeric);
end; 
$function$
;

select * from public.get_open_po_report('100002');


CREATE OR REPLACE FUNCTION public.get_report_stockopname(stockopname_id int)
 RETURNS TABLE(
    name character varying,
    damdealercode character varying,
    address character varying,
    stockopnamenumber character varying,
    docdate timestamp,
    whdesc character varying,
    sbidesc character varying,
    loccode character varying,
    partid character varying,
    partdesc character varying,
    stockquantity int,
    diffquantity int,
    actquantity int,
    het double precision,
    totalharga double precision, 
    totaldiff double precision,
    keterangan text
)
LANGUAGE plpgsql
AS $function$  
begin
  RETURN QUERY
select stokopname.*
  from dblink('dbname=ddmsh3_trn_cbr host=localhost user=ddmsh3app password=h1h2h3bandung port=5432'::text, 
      format('SELECT * FROM public.report_stockopname(%L)', stockopname_id)) stokopname
      (    
	    name character varying,
	    damdealercode character varying,
	    address character varying,
	    stockopnamenumber character varying,
	    docdate timestamp,
	    whdesc character varying,
	    sbidesc character varying,
	    loccode character varying,
	    partid character varying,
	    partdesc character varying,
	    stockquantity int,
	    diffquantity int,
	    actquantity int,
	    het double precision,
	    totalharga double precision, 
	    totaldiff double precision,
	    keterangan text
	   );
end; 
$function$
;

select * from public.get_report_stockopname(1570);
